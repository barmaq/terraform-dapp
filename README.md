# Terraform Infrastructure for Kubernetes Application

## Описание проекта

Этот проект разворачивает полноценную инфраструктуру в Yandex Cloud для Kubernetes приложения с мониторингом.  

До запуска этих  манифестов уже созданы VPC, сертификат на dns имя app.barmaq.ru  и s3 хранилище для стейта.  

Чувствительные переменные добавлены в секреты Github Actions.
Для локального запуска используется файл secret.auto.tfvars добавленный в .gitignore.  

## Архитектура

- **Kubernetes кластер** с control plane и worker nodes
- **Приложение** развернутое в кластере
- **Grafana** для мониторинга
- **Load Balancers** для доступа к сервисам
- **DNS** записи для доменных имен

## Terraform манифесты

### Основные файлы

#### `main.tf`
Основной файл конфигурации, содержит:
- Настройки VPC сети
- Подсети в разных зонах
- Базовые настройки проекта

#### `providers.tf`
Настройки провайдеров:
- Yandex Cloud провайдер
- Backend конфигурация для S3 (state хранится в Yandex Object Storage)
- Версии провайдеров

#### `variables.tf`
Определение всех переменных:
- Параметры облака (cloud_id, folder_id, token)
- Конфигурация VM (CPU, RAM, диски)
- Настройки приложения
- SSH ключи и пароли ( через секреты )  

#### `locals.tf`
Локальные переменные:
- SSH публичный ключ  ( для переиспользования )  
- Список зон для переиспользования

### Инфраструктура

#### `k8s-cluster.tf`
Создание Kubernetes кластера:
- Установка Ansible на CP ноду созданную первой 
- Установка кластера через Kubespray

#### `k8s-cp.tf`
Control Plane узлы:
- VM для мастер-узлов

#### `k8s-nodes.tf`
Worker узлы:
- VM для рабочих узлов

#### `app.tf`
Развертывание приложения:
- Namespace для приложения
- Deployment с репликами
- Service (NodePort)

### Сетевые сервисы

#### `load-balancer.tf`
Настройка балансировщиков нагрузки:
- **ALB для приложения** (HTTPS с SSL)
- **NLB для Grafana** (HTTP)
- **DNS записи** для доменных имен
- **Target Groups**  

### Мониторинг

#### `graphana.tf`
Установка и настройка мониторинга:
- Prometheus stack через Helm
- Grafana с пользовательским паролем
- NodePort сервис для доступа

### Выходные данные

#### `outputs.tf`
Информация о развернутой инфраструктуре:
- IP адреса узлов
- URL для доступа к приложению
- URL для доступа к Grafana
- Kubeconfig файлы
- Версия проекта


## Переменные окружения

Для работы проекта необходимо настроить следующие секреты в GitHub Actions:

- `YC_TOKEN` - IAM токен Yandex Cloud
- `YC_CLOUD_ID` - ID облака
- `YC_FOLDER_ID` - ID папки
- `YC_ACCESS_KEY` - Access Key для S3
- `YC_SECRET_KEY` - Secret Key для S3
- `SSH_PRIVATE_KEY` - Приватный SSH ключ
- `GRAFANA_ADMIN_PASSWORD` - Пароль администратора Grafana

## Запуск

1. Настройте секреты в GitHub Actions
2. Запустите CI/CD pipeline
3. Дождитесь завершения развертывания
4. Получите доступ к сервисам через outputs

## Версия

**Текущая версия:** 1.0.1

## Автор

Шумский Виктор / barmaq
Проект создан для дипломной работы по автоматизации развертывания инфраструктуры. 